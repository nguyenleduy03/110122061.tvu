-- Drop tables and constraints if they exist
IF EXISTS (SELECT 1 FROM sys.sysreferences r JOIN sys.sysobjects o ON (o.id = r.constid AND o.type = 'F')
           WHERE r.fkeyid = OBJECT_ID('HOKHAU') AND o.name = 'FK_HOKHAU_DANGKY_PHUONGXA')
   ALTER TABLE HOKHAU DROP CONSTRAINT FK_HOKHAU_DANGKY_PHUONGXA;

IF EXISTS (SELECT 1 FROM sys.sysreferences r JOIN sys.sysobjects o ON (o.id = r.constid AND o.type = 'F')
           WHERE r.fkeyid = OBJECT_ID('NHANKHAU') AND o.name = 'FK_NHANKHAU_CUA_HOKHAU')
   ALTER TABLE NHANKHAU DROP CONSTRAINT FK_NHANKHAU_CUA_HOKHAU;

IF EXISTS (SELECT 1 FROM sys.sysreferences r JOIN sys.sysobjects o ON (o.id = r.constid AND o.type = 'F')
           WHERE r.fkeyid = OBJECT_ID('PHUONGXA') AND o.name = 'FK_PHUONGXA_THUOC_QUANHUYE')
   ALTER TABLE PHUONGXA DROP CONSTRAINT FK_PHUONGXA_THUOC_QUANHUYE;

-- Drop indexes if they exist
IF EXISTS (SELECT 1 FROM sysindexes WHERE id = OBJECT_ID('HOKHAU') AND name = 'DANGKY_FK' AND indid > 0 AND indid < 255)
   DROP INDEX HOKHAU.DANGKY_FK;

IF EXISTS (SELECT 1 FROM sysindexes WHERE id = OBJECT_ID('NHANKHAU') AND name = 'CUA_FK' AND indid > 0 AND indid < 255)
   DROP INDEX NHANKHAU.CUA_FK;

IF EXISTS (SELECT 1 FROM sysindexes WHERE id = OBJECT_ID('PHUONGXA') AND name = 'THUOC_FK' AND indid > 0 AND indid < 255)
   DROP INDEX PHUONGXA.THUOC_FK;

-- Drop tables if they exist
IF EXISTS (SELECT 1 FROM sysobjects WHERE id = OBJECT_ID('HOKHAU') AND type = 'U') DROP TABLE HOKHAU;
IF EXISTS (SELECT 1 FROM sysobjects WHERE id = OBJECT_ID('NHANKHAU') AND type = 'U') DROP TABLE NHANKHAU;
IF EXISTS (SELECT 1 FROM sysobjects WHERE id = OBJECT_ID('PHUONGXA') AND type = 'U') DROP TABLE PHUONGXA;
IF EXISTS (SELECT 1 FROM sysobjects WHERE id = OBJECT_ID('QUANHUYEN') AND type = 'U') DROP TABLE QUANHUYEN;

-- Create tables

CREATE TABLE HOKHAU (
   SOSO VARCHAR(20) NOT NULL,
   MAPX VARCHAR(10) NOT NULL,
   HOTENCH VARCHAR(50) NULL,
   SONHA VARCHAR(20) NULL,
   TENDUONG VARCHAR(50) NULL,
   KHUPHOAP VARCHAR(10) NULL,
   CONSTRAINT PK_HOKHAU PRIMARY KEY NONCLUSTERED (SOSO)
);

CREATE INDEX DANGKY_FK ON HOKHAU (MAPX ASC);

CREATE TABLE NHANKHAU (
   MANK VARCHAR(10) NOT NULL,
   SOSO VARCHAR(20) NOT NULL,
   HOTEN VARCHAR(50) NULL,
   GIOITINH VARCHAR(5) NULL,
   NGAYSINH DATETIME NULL,
   CONSTRAINT PK_NHANKHAU PRIMARY KEY NONCLUSTERED (MANK)
);

CREATE INDEX CUA_FK ON NHANKHAU (SOSO ASC);

CREATE TABLE PHUONGXA (
   MAPX VARCHAR(10) NOT NULL,
   MAQH VARCHAR(10) NOT NULL,
   TENPX VARCHAR(50) NULL,
   CONSTRAINT PK_PHUONGXA PRIMARY KEY NONCLUSTERED (MAPX)
);

CREATE INDEX THUOC_FK ON PHUONGXA (MAQH ASC);

CREATE TABLE QUANHUYEN (
   MAQH VARCHAR(10) NOT NULL,
   TENQH VARCHAR(50) NULL,
   CONSTRAINT PK_QUANHUYEN PRIMARY KEY NONCLUSTERED (MAQH)
);

-- Insert sample data

-- Insert data into HOKHAU
INSERT INTO HOKHAU (SOSO, MAPX, HOTENCH, SONHA, TENDUONG, KHUPHOAP)
VALUES
('SH12345', 'PX001', 'Nguyen Thi Mai', '123', 'Nguyen Trai', 'KP01'),
('SH12346', 'PX002', 'Tran Minh Tu', '456', 'Le Loi', 'KP02'),
('SH12347', 'PX003', 'Le Thi Hoa', '789', 'Hai Ba Trung', 'KP03'),
('SH12348', 'PX004', 'Pham Quoc Duy', '101', 'Ba Thang Hai', 'KP04'),
('SH12349', 'PX005', 'Nguyen Thi Lan', '202', 'Nguyen Du', 'KP05');

-- Insert data into NHANKHAU
INSERT INTO NHANKHAU (MANK, SOSO, HOTEN, GIOITINH, NGAYSINH)
VALUES
('NK001', 'SH12345', 'Nguyen Thi Mai', 'Nu', '1990-01-15'),
('NK002', 'SH12346', 'Tran Minh Tu', 'Nam', '1985-03-20'),
('NK003', 'SH12347', 'Le Thi Hoa', 'Nu', '1992-07-25'),
('NK004', 'SH12348', 'Pham Quoc Duy', 'Nam', '1987-09-30'),
('NK005', 'SH12349', 'Nguyen Thi Lan', 'Nu', '1995-02-10');

-- Insert data into PHUONGXA
INSERT INTO PHUONGXA (MAPX, MAQH, TENPX)
VALUES
('PX001', 'QH001', 'Phuong 1'),
('PX002', 'QH001', 'Phuong 2'),
('PX003', 'QH002', 'Phuong 3'),
('PX004', 'QH003', 'Phuong 4'),
('PX005', 'QH003', 'Phuong 5');

-- Insert data into QUANHUYEN
INSERT INTO QUANHUYEN (MAQH, TENQH)
VALUES
('QH001', 'Quan 1'),
('QH002', 'Quan 2'),
('QH003', 'Quan 3'),
('QH004', 'Quan 4'),
('QH005', 'Quan 5');

-- Add Foreign Key Constraints

ALTER TABLE HOKHAU
   ADD CONSTRAINT FK_HOKHAU_DANGKY_PHUONGXA FOREIGN KEY (MAPX)
      REFERENCES PHUONGXA (MAPX);

ALTER TABLE NHANKHAU
   ADD CONSTRAINT FK_NHANKHAU_CUA_HOKHAU FOREIGN KEY (SOSO)
      REFERENCES HOKHAU (SOSO);

ALTER TABLE PHUONGXA
   ADD CONSTRAINT FK_PHUONGXA_THUOC_QUANHUYE FOREIGN KEY (MAQH)
      REFERENCES QUANHUYEN (MAQH);
      
SELECT * FROM HOKHAU;
